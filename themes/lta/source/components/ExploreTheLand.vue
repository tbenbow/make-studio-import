<template>
  <div ref="rootEl" class="explore-the-land" :class="{ 'is-active': isActive }">
    <transition v-if="hasPanel" name="panel-transition">
      <aside v-show="isActive" class="panel">
        <RichText size="small">
          <slot v-bind="{ title, description, footnote }">
            <h6 v-if="computedTitle" class="panel-title">
              {{ computedTitle }}
            </h6>
            <p v-if="description" class="description">{{ description }}</p>
            <p v-if="footnote" class="footnote">{{ footnote }}</p>
            <ButtonComponent
              v-if="landTrustLink"
              :link="landTrustLink"
              name="View Land Trust"
              size="small"
              variation="link"
            />
          </slot>
        </RichText>
      </aside>
    </transition>
    <div class="main">
      <div v-if="showLabel" class="label">
        <h6 class="label-text">Explore the Land</h6>
      </div>
      <button
        class="btn"
        :disabled="!hasPanel"
        aria-label="Explore the Land"
        @click="isActive = !isActive"
      >
        <div class="btn-icon-container">
          <font-awesome-icon class="btn-icon" :icon="['fal', 'compass']" />
        </div>
        <svg
          class="btn-circle"
          viewBox="0 0 32 32"
          xmlns="http://www.w3.org/2000/svg"
          fill="currentColor"
        >
          <path
            d="M31.139 21.5236C22.8348 43.0814 -12.0355 28.3283 4.30205 4.74322C6.99606 -1.03243 18.5783 -0.822028 24.6615 1.61808C33.4054 4.57253 32.4822 13.9978 31.139 21.5236Z"
          />
        </svg>
      </button>
      <svg
        v-if="showTrail"
        class="trail"
        width="56"
        height="113"
        viewBox="0 0 56 113"
        xmlns="http://www.w3.org/2000/svg"
        fill="currentColor"
      >
        <path
          d="M18.5975 1.2519C19.2673 1.73947 19.415 2.67767 18.9274 3.34742C18.1465 4.42004 17.3299 5.4347 16.4978 6.40311C15.9579 7.03145 15.0108 7.10315 14.3825 6.56327C13.7542 6.02338 13.6825 5.07634 14.2223 4.448C15.012 3.52897 15.7769 2.57784 16.502 1.58175C16.9896 0.912001 17.9278 0.764323 18.5975 1.2519Z"
        />
        <path
          d="M11.2235 9.87114C11.8148 10.4513 11.8238 11.401 11.2437 11.9924C10.3404 12.913 9.47131 13.8032 8.64885 14.69C8.08549 15.2974 7.13642 15.3331 6.52903 14.7697C5.92163 14.2064 5.88593 13.2573 6.44928 12.6499C7.30364 11.7288 8.19962 10.8113 9.10224 9.89134C9.68242 9.3 10.6321 9.29096 11.2235 9.87114Z"
        />
        <path
          d="M4.29605 20.4022C4.69438 19.6759 4.42844 18.7641 3.70206 18.3658C2.97568 17.9675 2.06392 18.2334 1.6656 18.9598C1.00727 20.1603 0.471724 21.4271 0.106123 22.7833C-0.109515 23.5831 0.364098 24.4064 1.16397 24.622C1.96384 24.8377 2.78707 24.364 3.00271 23.5642C3.29813 22.4683 3.73646 21.4227 4.29605 20.4022Z"
        />
        <path
          d="M1.17568 29.2095C1.98397 29.028 2.78637 29.5361 2.96788 30.3444C3.09102 30.8927 3.24428 31.4599 3.43017 32.0475C3.62405 32.6604 3.84268 33.2263 4.08348 33.7486C4.43031 34.5009 4.10159 35.392 3.34927 35.7388C2.59694 36.0856 1.70589 35.7569 1.35906 35.0046C1.06237 34.361 0.799211 33.6773 0.569888 32.9524C0.359553 32.2876 0.183606 31.6377 0.0407794 31.0017C-0.140732 30.1934 0.367378 29.391 1.17568 29.2095Z"
        />
        <path
          d="M66.5217 30.4201C65.7053 30.2797 64.9296 30.8278 64.7893 31.6442C64.6489 32.4607 65.197 33.2363 66.0134 33.3767C67.2606 33.5911 68.3658 33.9443 69.3288 34.4467C70.0632 34.8299 70.9693 34.5452 71.3525 33.8107C71.7357 33.0763 71.451 32.1702 70.7165 31.787C69.4291 31.1153 68.0167 30.6771 66.5217 30.4201Z"
        />
        <path
          d="M59.8398 31.7424C59.9462 32.564 59.3665 33.3163 58.545 33.4227C57.3167 33.5819 56.0398 33.7998 54.7217 34.0648C53.9095 34.2281 53.1187 33.702 52.9554 32.8899C52.7921 32.0777 53.3182 31.2869 54.1303 31.1236C55.5027 30.8477 56.8494 30.6174 58.1594 30.4476C58.981 30.3411 59.7333 30.9208 59.8398 31.7424Z"
        />
        <path
          d="M47.1129 35.9218C47.9116 35.7018 48.3807 34.876 48.1607 34.0773C47.9407 33.2786 47.1149 32.8095 46.3162 33.0295C45.043 33.3802 43.7586 33.7475 42.4706 34.1216C41.6751 34.3528 41.2176 35.185 41.4487 35.9806C41.6798 36.7761 42.5121 37.2336 43.3076 37.0025C44.588 36.6305 45.858 36.2675 47.1129 35.9218Z"
        />
        <path
          d="M36.705 37.3776C36.9334 38.1739 36.473 39.0046 35.6767 39.233C34.3884 39.6025 33.1018 39.9631 31.8242 40.3056C31.024 40.5201 30.2015 40.0453 29.987 39.2451C29.7725 38.4449 30.2473 37.6224 31.0475 37.4079C32.3033 37.0713 33.5723 36.7156 34.8496 36.3492C35.6459 36.1209 36.4766 36.5813 36.705 37.3776Z"
        />
        <path
          d="M76.37 38.5642C76.0951 37.7827 75.2387 37.3721 74.4572 37.647C73.6757 37.9219 73.2651 38.7783 73.54 39.5598C73.73 40.0997 73.8958 40.6854 74.0346 41.3203C74.155 41.8711 74.2034 42.3874 74.1914 42.8748C74.171 43.703 74.8258 44.3909 75.654 44.4112C76.4822 44.4316 77.1701 43.7768 77.1905 42.9486C77.2087 42.2075 77.1341 41.4512 76.9654 40.6796C76.8024 39.9339 76.6039 39.229 76.37 38.5642Z"
        />
        <path
          d="M6.73734 39.3268C7.10069 38.5823 7.99878 38.2733 8.74327 38.6367C9.74917 39.1276 10.8772 39.4783 12.1238 39.7008C12.9394 39.8463 13.4825 40.6254 13.337 41.4409C13.1915 42.2565 12.4124 42.7996 11.5969 42.6541C10.1231 42.3912 8.72227 41.9647 7.42743 41.3327C6.68295 40.9694 6.37398 40.0713 6.73734 39.3268Z"
        />
        <path
          d="M73.1864 50.5749C73.799 50.0171 73.8434 49.0684 73.2856 48.4559C72.7279 47.8433 71.7792 47.7989 71.1666 48.3567C70.3545 49.0961 69.3954 49.8242 68.3054 50.5526C67.6166 51.0128 67.4313 51.9443 67.8915 52.6331C68.3518 53.3219 69.2833 53.5072 69.9721 53.047C71.1488 52.2607 72.2346 51.4416 73.1864 50.5749Z"
        />
        <path
          d="M63.8175 54.9235C64.1989 55.6589 63.9119 56.5643 63.1765 56.9457C62.0596 57.525 60.908 58.107 59.7412 58.6952C59.0015 59.0681 58.0995 58.7708 57.7266 58.031C57.3536 57.2913 57.651 56.3893 58.3907 56.0163C59.5578 55.428 60.6954 54.853 61.7953 54.2826C62.5307 53.9012 63.4361 54.1881 63.8175 54.9235Z"
        />
        <path
          d="M52.9619 62.1875C53.6911 61.7943 53.9634 60.8844 53.5702 60.1552C53.1769 59.4261 52.267 59.1538 51.5379 59.547C50.4037 60.1587 49.2694 60.7914 48.1476 61.4499C47.4332 61.8693 47.194 62.7884 47.6134 63.5028C48.0327 64.2173 48.9519 64.4565 49.6663 64.0371C50.7506 63.4006 51.8525 62.7858 52.9619 62.1875Z"
        />
        <path
          d="M43.713 66.0701C44.2167 66.7278 44.0919 67.6693 43.4343 68.173C42.4435 68.9319 41.4964 69.7214 40.6033 70.5466C39.9949 71.1089 39.0459 71.0714 38.4836 70.463C37.9214 69.8545 37.9589 68.9055 38.5673 68.3433C39.536 67.4482 40.555 66.5995 41.6101 65.7914C42.2677 65.2876 43.2093 65.4124 43.713 66.0701Z"
        />
        <path
          d="M35.9067 76.0768C36.3506 75.3774 36.1436 74.4505 35.4442 74.0065C34.7448 73.5625 33.8179 73.7695 33.3739 74.4689C32.6523 75.6056 32.0138 76.8033 31.4738 78.0679C31.1484 78.8298 31.5023 79.7112 32.2642 80.0365C33.026 80.3619 33.9074 80.008 34.2327 79.2461C34.7058 78.1385 35.2673 77.0839 35.9067 76.0768Z"
        />
        <path
          d="M31.1815 84.5735C32.0077 84.6348 32.6277 85.3542 32.5665 86.1803C32.5226 86.7725 32.5 87.3788 32.5 88C32.5 88.6294 32.5375 89.2384 32.6096 89.8281C32.7102 90.6504 32.1251 91.3986 31.3028 91.4991C30.4805 91.5996 29.7323 91.0145 29.6318 90.1922C29.5447 89.4796 29.5 88.749 29.5 88C29.5 87.3061 29.5252 86.6257 29.5747 85.9585C29.636 85.1323 30.3554 84.5122 31.1815 84.5735Z"
        />
        <path
          d="M35.2784 96.5373C34.7963 95.8636 33.8594 95.7082 33.1856 96.1903C32.5119 96.6723 32.3565 97.6093 32.8386 98.283C33.6682 99.4426 34.6239 100.518 35.6735 101.518C36.2733 102.089 37.2227 102.067 37.7942 101.467C38.3657 100.867 38.3429 99.9176 37.7431 99.3461C36.8118 98.4586 35.9845 97.5243 35.2784 96.5373Z"
        />
        <path
          d="M52.7308 109.721C53.0349 108.95 53.9062 108.572 54.6768 108.876C55.2996 109.122 55.9206 109.363 56.5376 109.599C57.3111 109.896 57.6978 110.763 57.4013 111.537C57.1048 112.31 56.2373 112.697 55.4638 112.401C54.8396 112.161 54.2092 111.917 53.5752 111.667C52.8047 111.362 52.4266 110.491 52.7308 109.721Z"
        />
        <path
          d="M47.9859 110.978C48.1776 111.496 47.8796 112.081 47.3474 112.23C47.0952 112.312 46.8299 112.282 46.6072 112.169C46.3566 112.041 46.1764 111.844 46.0944 111.592L44.6605 107.179L40.2194 108.599C39.9672 108.681 39.7019 108.651 39.4791 108.537C39.2285 108.409 39.0483 108.212 38.9664 107.96C38.7747 107.442 39.0726 106.857 39.6048 106.707L44.0323 105.245L42.5983 100.832C42.4066 100.314 42.7045 99.7288 43.2367 99.5791C43.7553 99.3874 44.34 99.6853 44.4897 100.218L45.9515 104.645L50.3648 103.211C50.8834 103.019 51.4681 103.317 51.6178 103.849C51.8095 104.368 51.5116 104.953 50.9794 105.102L46.5519 106.564L47.9859 110.978Z"
        />
        <path
          d="M26.7139 45.1364C27.0787 44.721 27.0101 44.0684 26.5669 43.7379L22.9607 40.8176L25.8777 37.1803C26.2425 36.7649 26.1739 36.1122 25.7307 35.7817C25.3153 35.4169 24.6626 35.4855 24.3321 35.9287L21.4118 39.535L17.7745 36.618C17.3591 36.2531 16.7064 36.3217 16.376 36.7649C16.0111 37.1804 16.0797 37.833 16.523 38.1635L20.1292 41.0838L17.2122 44.7211C16.8474 45.1365 16.916 45.7892 17.3592 46.1197C17.5653 46.2865 17.8237 46.3536 18.1034 46.3242C18.352 46.2981 18.5909 46.1787 18.7577 45.9727L21.7091 42.3631L25.3154 45.2834C25.5214 45.4503 25.7799 45.5174 26.0596 45.488C26.3082 45.4619 26.547 45.3425 26.7139 45.1364Z"
        />
      </svg>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onClickOutside, useMounted } from '@vueuse/core'

const props = defineProps({
  title: String,
  description: String,
  footnote: String,
  landTrustId: String,
  showLabel: Boolean,
  showTrail: Boolean
})

const rootEl = ref<HTMLElement | null>(null)
const slots = useSlots()
const isMounted = useMounted()
const isActive = ref(false)
const stopOnClickOutside = ref<Function | null>(null)

const key = `explore-the-land-${useId()}`

const { data: landTrust, execute: fetchLandTrust } = await useLazyFetch<any>(`/api/land-trusts/${props.landTrustId}`, {
  key,
  immediate: false,
  server: false
})

const hasPanel = computed(() => {
  return isMounted && (
    props.title ||
    props.description ||
    props.footnote ||
    landTrust.value ||
    slots.default
  )
})

const computedTitle = computed(() => {
  return props.title || landTrust.value?.name
})

const landTrustLink = computed(() => {
  return landTrust.value?.slug
    ? resolveRoute('land-trust', landTrust.value.slug)
    : undefined
})

onMounted(() => {
  if (props.landTrustId) {
    fetchLandTrust()
  }
})

watch(
  isActive,
  (newValue) => {
    if (newValue === true) {
      stopOnClickOutside.value = onClickOutside(rootEl.value, (e) => {
        isActive.value = false
      })
    } else if (stopOnClickOutside.value) {
      stopOnClickOutside.value()
    }
  }
)
</script>

<style lang="postcss" scoped>
.explore-the-land {
  @apply relative;
}

.panel {
  @apply absolute bottom-[16px] right-[16px] w-96 p-4 pr-12 bg-orange rounded-xl shadow-dark origin-bottom-right;

  &-transition {
    &-enter-from,
    &-leave-to {
      @apply opacity-0 scale-0;
    }

    &-enter-active,
    &-leave-active {
      @apply transition duration-200 ease-in-out;
    }

    &-enter-active {
      @apply delay-100;
    }
  }

  :deep(.rich-text) {
    --color-accent: var(--color-body);
    --color-heading: theme('colors.stone');

    .footnote {
      @apply -mt-1 text-2xs text-body-3 uppercase tracking-wide;
    }

    .btn {
      @apply mt-0;
    }
  }

  .footnote {
  }
}

.main {
  @apply relative h-[64px] w-[64px] p-[16px] text-orange;

  .label {
    @apply absolute top-0 left-0 flex items-center h-[64px] whitespace-nowrap -rotate-90 origin-top-left;
    @apply transition duration-200 ease-in-out;
  }

  .btn {
    @apply relative block h-[32px] w-[32px] transition-transform duration-200 ease-in-out;

    &-icon-container {
      @apply absolute flex items-center justify-center h-full w-full;
      @apply transition-transform duration-500 ease-in-out;
    }

    &-icon {
      @apply text-black text-lg;
    }

    &-circle {
      @apply h-full w-full;
    }

    &:hover {
      @apply scale-105;
    }
  }

  .trail {
    @apply absolute top-full right-0 mt-[-14px] pointer-events-none;
  }
}

/* Is Active */

.explore-the-land.is-active {
  .main {
    .label {
      @apply opacity-0 translate-y-4;
    }

    .btn-icon-container {
      @apply rotate-180;
    }
  }
}
</style>
